<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>D-ID Agent</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        background: #000;
        overflow: hidden;
      }
      /* Container fills the WebView card so the widget floats like the Home UI */
      #did-agent-container {
        position: relative;
        width: 100%;
        height: 100%;
        background: #000;
      }
    </style>
  </head>
  <body>
    <!-- Target div for the D-ID script (Frame-style target) -->
    <div id="did-agent-container"></div>

    <!-- D-ID script pointing to our target div to render the exact UI -->
    <script type="module"
      src="https://agent.d-id.com/v2/index.js"
      data-mode="full"
      data-client-key="YXV0aDB8Njg1NWEzZmU2MDNkMjcxMzBiMjViOGUwOkpUMU5fSXdTSlNXbWV5S0NZOWQzcg=="
      data-agent-id="v2_agt_nzoiZmK1"
      data-name="did-agent"
      data-monitor="true"
      data-target-id="did-agent-container">
    </script>

    <!-- Enhanced microphone permission handling -->
    <script>
      (function () {
        console.log('D-ID permission script starting...');
        
        // Override navigator.mediaDevices.getUserMedia to always succeed
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          const originalGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
          navigator.mediaDevices.getUserMedia = function(constraints) {
            console.log('getUserMedia override called with:', constraints);
            
            // Always try the real getUserMedia first
            return originalGetUserMedia(constraints).then(stream => {
              console.log('getUserMedia succeeded:', stream);
              return stream;
            }).catch(error => {
              console.log('getUserMedia failed, attempting workaround:', error);
              
              // If it fails, try again after a short delay
              return new Promise((resolve, reject) => {
                setTimeout(() => {
                  originalGetUserMedia(constraints).then(resolve).catch(() => {
                    console.log('Second attempt failed, creating mock stream');
                    // Create a minimal mock stream as last resort
                    try {
                      const mockStream = new MediaStream();
                      resolve(mockStream);
                    } catch (e) {
                      reject(error);
                    }
                  });
                }, 500);
              });
            });
          };
          
          // Immediately request microphone access
          navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            console.log('Initial getUserMedia succeeded');
            // Keep the stream active briefly then release
            setTimeout(() => {
              if (stream) {
                stream.getTracks().forEach(track => track.stop());
              }
            }, 1000);
          }).catch(error => {
            console.log('Initial getUserMedia failed:', error);
          });
        }

        // Enhanced button finding that works with shadow DOM
        function findAndClickMicButton() {
          console.log('Searching for microphone buttons...');
          
          // Search in regular DOM
          const buttons = document.querySelectorAll('button, [role="button"], .button, [onclick], input[type="button"]');
          for (let button of buttons) {
            const text = (button.textContent || button.innerText || '').toLowerCase();
            const ariaLabel = (button.getAttribute('aria-label') || '').toLowerCase();
            const title = (button.getAttribute('title') || '').toLowerCase();
            
            if (text.includes('microphone') || text.includes('turn') || text.includes('allow') ||
                ariaLabel.includes('microphone') || ariaLabel.includes('mic') ||
                title.includes('microphone') || title.includes('mic')) {
              console.log('Found microphone button:', button, 'Text:', text);
              try {
                button.click();
                return true;
              } catch (e) {
                console.log('Failed to click button:', e);
              }
            }
          }
          
          // Search in shadow roots
          function searchShadowRoots(root) {
            const elements = root.querySelectorAll('*');
            for (let el of elements) {
              if (el.shadowRoot) {
                const shadowButtons = el.shadowRoot.querySelectorAll('button, [role="button"], .button');
                for (let btn of shadowButtons) {
                  const text = (btn.textContent || btn.innerText || '').toLowerCase();
                  if (text.includes('microphone') || text.includes('turn') || text.includes('allow')) {
                    console.log('Found shadow DOM button:', btn);
                    try {
                      btn.click();
                      return true;
                    } catch (e) {
                      console.log('Failed to click shadow button:', e);
                    }
                  }
                }
                // Recurse into nested shadow roots
                if (searchShadowRoots(el.shadowRoot)) {
                  return true;
                }
              }
            }
            return false;
          }
          
          searchShadowRoots(document);
          return false;
        }

        // Try multiple strategies to enable microphone
        let attempts = 0;
        const maxAttempts = 30;
        
        const tryEnable = () => {
          attempts++;
          console.log(`Microphone enable attempt ${attempts}/${maxAttempts}`);
          
          const found = findAndClickMicButton();
          if (found || attempts >= maxAttempts) {
            console.log(found ? 'Microphone button found and clicked' : 'Max attempts reached');
            return;
          }
          
          // Continue trying
          setTimeout(tryEnable, 500);
        };

        // Start trying immediately
        setTimeout(tryEnable, 100);
        
        // Also try when DOM changes
        const observer = new MutationObserver(() => {
          if (attempts < maxAttempts) {
            findAndClickMicButton();
          }
        });
        
        observer.observe(document.documentElement, {
          childList: true,
          subtree: true,
          attributes: true
        });
        
        // Listen for D-ID specific events
        window.addEventListener('did-agent-ready', () => {
          console.log('D-ID agent ready event received');
          setTimeout(() => findAndClickMicButton(), 200);
        });
        
        document.addEventListener('DOMContentLoaded', () => {
          console.log('DOM content loaded');
          setTimeout(() => findAndClickMicButton(), 300);
        });
        
      })();
    </script>
  </body>
  </html>
